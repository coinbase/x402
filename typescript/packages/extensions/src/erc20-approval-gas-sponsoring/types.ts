/**
 * Type definitions for the ERC-20 Approval Gas Sponsoring Extension
 *
 * This extension enables gasless Permit2 approval for generic ERC-20 tokens
 * that do NOT implement EIP-2612. The client signs (but does not broadcast) a
 * raw `approve(Permit2, MaxUint256)` transaction, and the facilitator broadcasts
 * it atomically before settling the Permit2 payment.
 */

import type { FacilitatorExtension } from "@x402/core/types";

/**
 * Signer capability carried by the ERC-20 approval extension when registered in a facilitator.
 *
 * Mirrors FacilitatorEvmSigner (from @x402/evm) plus `sendRawTransaction`.
 * The extension signer owns the full approve+settle flow: it broadcasts the
 * pre-signed approval transaction AND executes the Permit2 settle call, enabling
 * production implementations to bundle both atomically (e.g., Flashbots, multicall).
 *
 * The method signatures are duplicated here (rather than extending FacilitatorEvmSigner)
 * to avoid a circular dependency between @x402/extensions and @x402/evm.
 */
export interface Erc20ApprovalGasSponsoringSigner {
  getAddresses(): readonly `0x${string}`[];
  readContract(args: {
    address: `0x${string}`;
    abi: readonly unknown[];
    functionName: string;
    args?: readonly unknown[];
  }): Promise<unknown>;
  verifyTypedData(args: {
    address: `0x${string}`;
    domain: Record<string, unknown>;
    types: Record<string, unknown>;
    primaryType: string;
    message: Record<string, unknown>;
    signature: `0x${string}`;
  }): Promise<boolean>;
  writeContract(args: {
    address: `0x${string}`;
    abi: readonly unknown[];
    functionName: string;
    args: readonly unknown[];
  }): Promise<`0x${string}`>;
  sendTransaction(args: { to: `0x${string}`; data: `0x${string}` }): Promise<`0x${string}`>;
  waitForTransactionReceipt(args: { hash: `0x${string}` }): Promise<{ status: string }>;
  getCode(args: { address: `0x${string}` }): Promise<`0x${string}` | undefined>;
  sendRawTransaction(args: { serializedTransaction: `0x${string}` }): Promise<`0x${string}`>;
}

/**
 * Extension identifier for the ERC-20 approval gas sponsoring extension.
 */
export const ERC20_APPROVAL_GAS_SPONSORING: FacilitatorExtension = {
  key: "erc20ApprovalGasSponsoring",
};

/** Current schema version for the ERC-20 approval gas sponsoring extension info. */
export const ERC20_APPROVAL_GAS_SPONSORING_VERSION = "1";

/**
 * Extended extension object registered in a facilitator via registerExtension().
 * Carries the signer that owns the full approve+settle flow for ERC-20 tokens
 * that lack EIP-2612. The signer must have all FacilitatorEvmSigner capabilities
 * plus `sendRawTransaction` for broadcasting the pre-signed approval tx.
 *
 * @example
 * ```typescript
 * const erc20GasSponsorshipExtension: Erc20ApprovalGasSponsoringFacilitatorExtension = {
 *   ...ERC20_APPROVAL_GAS_SPONSORING,
 *   signer: {
 *     ...evmSigner,
 *     sendRawTransaction: (args) => viemClient.sendRawTransaction(args),
 *   },
 * };
 * facilitator.registerExtension(erc20GasSponsorshipExtension);
 * ```
 */
export interface Erc20ApprovalGasSponsoringFacilitatorExtension extends FacilitatorExtension {
  key: "erc20ApprovalGasSponsoring";
  /** Signer with broadcast + settle capability. Optional — settlement fails gracefully if absent. */
  signer?: Erc20ApprovalGasSponsoringSigner;
}

/**
 * ERC-20 approval gas sponsoring info populated by the client.
 *
 * Contains the RLP-encoded signed `approve(Permit2, MaxUint256)` transaction
 * that the facilitator broadcasts before settling the Permit2 payment.
 *
 * Note: Unlike EIP-2612, there is no nonce/deadline/signature — instead the
 * entire signed transaction is included as `signedTransaction`.
 */
export interface Erc20ApprovalGasSponsoringInfo {
  /** Index signature for compatibility with Record<string, unknown> */
  [key: string]: unknown;
  /** The address of the sender (token owner who signed the tx). */
  from: `0x${string}`;
  /** The address of the ERC-20 token contract. */
  asset: `0x${string}`;
  /** The address of the spender (Canonical Permit2). */
  spender: `0x${string}`;
  /** The amount approved (uint256 as decimal string). Always MaxUint256. */
  amount: string;
  /** The RLP-encoded signed EIP-1559 transaction as a hex string. */
  signedTransaction: `0x${string}`;
  /** Schema version identifier. */
  version: string;
}

/**
 * Server-side ERC-20 approval gas sponsoring info included in PaymentRequired.
 * Contains a description and version; the client populates the rest.
 */
export interface Erc20ApprovalGasSponsoringServerInfo {
  /** Index signature for compatibility with Record<string, unknown> */
  [key: string]: unknown;
  /** Human-readable description of the extension. */
  description: string;
  /** Schema version identifier. */
  version: string;
}

/**
 * The full extension object as it appears in PaymentRequired.extensions
 * and PaymentPayload.extensions.
 */
export interface Erc20ApprovalGasSponsoringExtension {
  /** Extension info - server-provided or client-enriched. */
  info: Erc20ApprovalGasSponsoringServerInfo | Erc20ApprovalGasSponsoringInfo;
  /** JSON Schema describing the expected structure of info. */
  schema: Record<string, unknown>;
}
