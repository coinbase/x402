# Sign-In-With-X Extension TODO

## Overview

Implement the Sign-In-With-X (SIWx) extension for the x402 protocol, providing CAIP-122 standard wallet-based identity assertions. This extension allows clients to prove control of a wallet that may have previously paid for a resource, enabling servers to grant access without requiring repurchase.

## Core Exports Required

### Server-Side Exports

```typescript
// Extension declaration helper for servers
export function declareSIWxExtension(options: {
  resourceUri: string;  // Full URI of the resource (domain derived from this)
  statement?: string;
  version?: string;  // Defaults to "1"
  network: `${string}:${string}`;  // e.g., "eip155:8453"
  expirationTime?: string;  // Auto-set to +5 minutes if not provided
  signatureScheme?: 'eip191' | 'eip712' | 'eip1271' | 'eip6492' | 'siws' | 'sep10';
}): SIWxExtension;

// Header parsing for servers
export function parseSIWxHeader(header: string): SIWxPayload;

// Message validation
export function validateSIWxMessage(
  message: SIWxPayload,
  expectedResourceUri: string,  // Validates domain is derived correctly from URI
  options?: {
    maxAge?: number;  // Maximum age of issuedAt (default: 5 minutes)
    checkNonce?: (nonce: string) => boolean;  // Custom nonce validation
  }
): { valid: boolean; error?: string };

// Signature verification
export function verifySIWxSignature(
  message: SIWxPayload,
  signature: string,
  options?: {
    provider?: any;  // Web3 provider for on-chain verification
    checkSmartWallet?: boolean;  // Enable EIP-1271/6492 verification
  }
): Promise<{ valid: boolean; address?: string; error?: string }>;
```

### Client-Side Exports

```typescript
// Header encoding for clients
export function encodeSIWxHeader(payload: SIWxPayload): string;

// Message construction helper
export function createSIWxMessage(
  serverInfo: SIWxExtensionInfo,
  address: string
): string;  // Returns CAIP-122 formatted message string

// Signature creation
export function signSIWxMessage(
  message: string,
  signer: any,  // Wallet/signer interface
  options?: {
    signatureScheme?: 'eip191' | 'eip712' | 'eip1271' | 'eip6492';
  }
): Promise<string>;

// Complete flow helper
export function createSIWxPayload(
  serverExtension: SIWxExtension,
  signer: any
): Promise<SIWxPayload>;
```

### Type Definitions

```typescript
export interface SIWxExtensionInfo {
  domain: string;  // Auto-derived from resourceUri (without https://)
  uri: string;  // Same as resourceUri
  statement?: string;
  version: string;
  chainId: string;  // Derived from network (e.g., "eip155:8453")
  nonce: string;  // Auto-generated by SDK
  issuedAt: string;  // Auto-generated by SDK
  expirationTime?: string;
  notBefore?: string;
  requestId?: string;
  resources: string[];  // Auto-generated as [resourceUri]
  signatureScheme?: string;
}

export interface SIWxExtension {
  info: SIWxExtensionInfo;
  schema: object;  // JSON Schema for validation
}

export interface SIWxPayload {
  domain: string;
  address: string;
  statement?: string;
  uri: string;
  version: string;
  chainId: string;
  nonce: string;
  issuedAt: string;
  expirationTime?: string;
  notBefore?: string;
  requestId?: string;
  resources?: string[];
  signature: string;
}
```

## Implementation Requirements

### Auto-Generated Fields

The SDK will automatically generate the following fields from the provided options:
- **domain**: Extracted from `resourceUri` by removing the protocol (https://)
- **uri**: Same as the provided `resourceUri`
- **chainId**: Same as the provided `network` parameter
- **nonce**: Cryptographically secure random string
- **issuedAt**: Current timestamp in ISO 8601 format
- **resources**: Array containing the `resourceUri`

### CAIP-122 Message Format

Implement proper CAIP-122 message construction:
```
{domain} wants you to sign in with your {chainId} account:
{address}

{statement}

URI: {uri}
Version: {version}
Chain ID: {chainId}
Nonce: {nonce}
Issued At: {issuedAt}
Expiration Time: {expirationTime}
Not Before: {notBefore}
Request ID: {requestId}
Resources:
- {resource1}
- {resource2}
```
